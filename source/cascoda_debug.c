/*
 * @file cascoda_debug.c
 * @brief Debug printing functions for Cascoda API code and applications.
 *
 * Copyright (C) 2016  Cascoda, Ltd.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <stdint.h>
#include <time.h>

#include "cascoda_debug.h"
#include "cascoda_api.h"

#define MAX_PUTC_CHARS  (128)

uint8_t PutcCount = 0;
uint8_t PutcBuffer[MAX_PUTC_CHARS];
uint8_t HexChars[16] = {'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};

void (*EVBME_Message)(char *message, size_t len, void *pDeviceRef);

// EVBME_Message Function for Upstream Communications in:
// - cascoda_serial_uart.c
// - cascoda_serial_usb.c
// void EVBME_Message( uint8_t Count, uint8_t *pBuffer, void *pDeviceRef );


/******************************************************************************/
/******************************************************************************/
/****** Putc()                                                           ******/
/******************************************************************************/
/****** Brief:  Put Character on Message Buffer                          ******/
/******************************************************************************/
/****** Param:  OutChar - Character to be displayed                      ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void Putc(uint8_t OutChar, void *pDeviceRef)
{
	if (OutChar == '\n') {
		dpFlush(pDeviceRef);
		return;
	}
	PutcBuffer[PutcCount] = OutChar;
	PutcCount++;
	if (PutcCount == MAX_PUTC_CHARS) {
		dpFlush(pDeviceRef);
	}
} // End of Putc()


/******************************************************************************/
/******************************************************************************/
/****** dpFlush()                                                        ******/
/******************************************************************************/
/****** Brief:  Send Message Upstream                                    ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dpFlush(void *pDeviceRef)
{
	if (PutcCount != 0) {
		if (EVBME_Message != NULL) {
			EVBME_Message((char *)PutcBuffer, PutcCount, pDeviceRef);
		}
		PutcCount = 0;
	}
} // End of dpFlush()


/******************************************************************************/
/******************************************************************************/
/****** dp8()                                                            ******/
/******************************************************************************/
/****** Brief:  DP Hexadecimal 8-bit Unsigned                            ******/
/******************************************************************************/
/****** Param:  Out - Value to be displayed                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp8(uint8_t Out, void *pDeviceRef)
{
	Putc(HexChars[Out>>4], pDeviceRef);
	Putc(HexChars[Out&15], pDeviceRef);
} // End of dp8()


/******************************************************************************/
/******************************************************************************/
/****** dp16()                                                           ******/
/******************************************************************************/
/****** Brief:  DP Hexadecimal 16-bit Unsigned                           ******/
/******************************************************************************/
/****** Param:  Out - Value to be displayed                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp16(uint16_t Out, void *pDeviceRef)
{
	dp8(MS_BYTE(Out), pDeviceRef);
	dp8(LS_BYTE(Out), pDeviceRef);
} // End of dp16()


/******************************************************************************/
/******************************************************************************/
/****** dp32()                                                           ******/
/******************************************************************************/
/****** Brief:  DP Hexadecimal 32-bit Unsigned                           ******/
/******************************************************************************/
/****** Param:  Out - Value to be displayed                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp32(uint32_t Out, void *pDeviceRef)
{
	dp8(LS3_BYTE(Out), pDeviceRef);
	dp8(LS2_BYTE(Out), pDeviceRef);
	dp8(LS1_BYTE(Out), pDeviceRef);
	dp8(LS0_BYTE(Out), pDeviceRef);
} // End of dp32()


/******************************************************************************/
/******************************************************************************/
/****** dps()                                                            ******/
/******************************************************************************/
/****** Brief:  DP Character String                                      ******/
/******************************************************************************/
/****** Param:  pString - Pointer to String                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dps(const uint8_t *pString, void *pDeviceRef)
{
	while (*pString != 0) {
		Putc(*pString++, pDeviceRef);
	}
} // End of dps()


/******************************************************************************/
/******************************************************************************/
/****** dptime()                                                         ******/
/******************************************************************************/
/****** Brief:  DP Time HH:MM:SS.MS                                      ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dptime(void)
{
	// u16_t MSecs;
	// Putc( (Hours/10)+'0' );
	// Putc( (Hours%10)+'0' );
	// Putc( ':' );
	// Putc( (Minutes/10)+'0' );
	// Putc( (Minutes%10)+'0' );
	// Putc( ':' );
	// Putc( (Seconds/10)+'0' );
	// Putc( (Seconds%10)+'0' );
	// Putc( '.' );
	// MSecs = Ticks;
	// Putc( (MSecs/100)+'0' );
	// Putc( ((MSecs%100)/10)+'0' );
	// dps("  ");
} // End of dptime()


/******************************************************************************/
/******************************************************************************/
/****** dparray()                                                        ******/
/******************************************************************************/
/****** Brief:  DP Array of Hexadecimal 8-bit Unsigned                   ******/
/******************************************************************************/
/****** Param:  pArray - Pointer to Array                                ******/
/****** Param:  Length - Length of Array                                 ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dparray(const uint8_t *pArray, uint8_t Length, void *pDeviceRef)
{
	while (Length) {
		dp8(*pArray++, pDeviceRef);
		Length--;
	}
} // End of dparray()


/******************************************************************************/
/******************************************************************************/
/****** dparrayle()                                                      ******/
/******************************************************************************/
/****** Brief:  DP Inverse Array of Hexadecimal 8-bit Unsigned           ******/
/******************************************************************************/
/****** Param:  pArray - Pointer to Array                                ******/
/****** Param:  Length - Length of Array                                 ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dparrayle(const uint8_t *pArray, uint8_t Length, void *pDeviceRef)
{
	while (Length) {
		Length--;
		dp8(pArray[Length], pDeviceRef);
	}
} // End of dparrayle()


/******************************************************************************/
/******************************************************************************/
/****** dpc()                                                            ******/
/******************************************************************************/
/****** Brief:  DP Character                                             ******/
/******************************************************************************/
/****** Param:  Out - Value to be displayed                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dpc(uint8_t Out, void *pDeviceRef)
{
	Putc( Out, pDeviceRef );
} // End of dpc()


/******************************************************************************/
/******************************************************************************/
/****** dpnl()                                                           ******/
/******************************************************************************/
/****** Brief:  DP New Line ('\n')                                       ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dpnl(void *pDeviceRef)
{
	Putc('\n', pDeviceRef);
} // End of dpnl()


/******************************************************************************/
/******************************************************************************/
/****** dpDec()                                                          ******/
/******************************************************************************/
/****** Brief:  DP 16-Bit Unsigned Decimal                               ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dpDec(uint16_t Out, void *pDeviceRef)
{
	uint8_t Sig = 0;
	uint16_t Div, Num, Rem;

	Num = Out;
	for (Div = 10000; Div > 1; Div /= 10) {
		Rem = Num%Div;
		Num = Num/Div;
		if (Num) {
			Sig = 1;
			Putc(HexChars[Num], pDeviceRef);
		} else if (Sig) {
			Putc('0', pDeviceRef);
		}
		Num = Rem;
	}
	Putc(HexChars[Num], pDeviceRef);
} // End of dpDec()


/******************************************************************************/
/******************************************************************************/
/****** dp_u8_2h()                                                       ******/
/******************************************************************************/
/****** Brief:  DP uint8_t to 2-Digit Hex                                   ******/
/******************************************************************************/
/****** Param:  x - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u8_2h(uint8_t x, void *pDeviceRef)
{
	Putc(HexChars[x>>4], pDeviceRef);
	Putc(HexChars[x&15], pDeviceRef);
} // End of dp_u8_2h()


/******************************************************************************/
/******************************************************************************/
/****** dp_u8_3u()                                                       ******/
/******************************************************************************/
/****** Brief:  DP uint8_t to 3-Digit Unsigned                              ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u8_3u(uint8_t d, void *pDeviceRef)
{
	uint8_t i, num, div, rem, ndone;

	num = d;
	ndone = 0;
	div=100;
	for (i = 0; i < 2; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
			else
				Putc(' ', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u8_3u()


/******************************************************************************/
/******************************************************************************/
/****** dp_u8_u()                                                        ******/
/******************************************************************************/
/****** Brief:  DP uint8_t to Variable Length Unsigned                      ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u8_u(uint8_t d, void *pDeviceRef)
{
	uint8_t i, num, div, rem, ndone;

	num = d;
	ndone = 0;
	div=100;
	for (i = 0; i < 2; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u8_u()


/******************************************************************************/
/******************************************************************************/
/****** dp_s8_s()                                                        ******/
/******************************************************************************/
/****** Brief:  DP i8_t to Variable Length Signed                        ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_s8_s(int8_t d, void *pDeviceRef)
{
	uint8_t i, num, div, rem, ndone;

	if (d < 0) {
		Putc('-', pDeviceRef);
		num = -d;
	} else {
		num = d;
	}
	ndone = 0;
	div=100;
	for (i = 0; i < 2; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_s8_s()


/******************************************************************************/
/******************************************************************************/
/****** dp_u16_5u()                                                      ******/
/******************************************************************************/
/****** Brief:  DP u16_t to 5-Digit Unsigned                             ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u16_5u(uint16_t d, void *pDeviceRef)
{
	uint8_t i, ndone;
	uint16_t num, div, rem;

	num = d;
	ndone = 0;
	div=10000;
	for (i = 0; i < 4; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
			else
				Putc(' ', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u16_5u()


/******************************************************************************/
/******************************************************************************/
/****** dp_u16_u()                                                       ******/
/******************************************************************************/
/****** Brief:  DP u16_t to Variable Length Unsigned                     ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u16_u(uint16_t d, void *pDeviceRef)
{
	uint8_t i, ndone;
	uint16_t num, div, rem;

	num = d;
	ndone = 0;
	div=10000;
	for (i = 0; i < 4; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u16_u()


/******************************************************************************/
/******************************************************************************/
/****** dp_s16_s()                                                       ******/
/******************************************************************************/
/****** Brief:  DP i16_t to Variable Length Signed                       ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_s16_s(int16_t d, void *pDeviceRef)
{
	uint8_t i, ndone;
	uint16_t num, div, rem;

	if (d < 0) {
		Putc('-', pDeviceRef);
		num = -d;
	} else {
		num = d;
	}
	ndone = 0;
	div=10000;
	for(i = 0; i < 4; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_s16_s()


/******************************************************************************/
/******************************************************************************/
/****** dp_u32_10u()                                                     ******/
/******************************************************************************/
/****** Brief:  DP u32_t to 10-Digit Unsigned                            ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u32_10u(uint32_t d, void *pDeviceRef)
{
	uint8_t i, ndone;
	uint32_t num, div, rem;

	num = d;
	ndone = 0;
	div=1000000000;
	for (i = 0; i < 9; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
			else
				Putc(' ', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u32_10u()


/******************************************************************************/
/******************************************************************************/
/****** dp_u32_u()                                                       ******/
/******************************************************************************/
/****** Brief:  DP u32_t to Variable Length Unsigned                     ******/
/******************************************************************************/
/****** Param:  d - Output Value                                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dp_u32_u(uint32_t d, void *pDeviceRef)
{
	uint8_t i, ndone;
	uint32_t num, div, rem;

	num = d;
	ndone = 0;
	div=1000000000;
	for (i = 0; i < 9; ++i) {
		rem = num%div;
		num = num/div;
		if (num) {
			ndone = 1;
			Putc(HexChars[num], pDeviceRef);
		} else {
			if (ndone)
				Putc('0', pDeviceRef);
		}
		num = rem;
		div /= 10;
	}
	Putc(HexChars[num], pDeviceRef);
} // End of dp_u32_u()


/******************************************************************************/
/******************************************************************************/
/****** dpslow()                                                         ******/
/******************************************************************************/
/****** Brief:  DP Character String and wait to clear                    ******/
/******************************************************************************/
/****** Param:  pString - Pointer to String                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void dpslow(const uint8_t *pString, void *pDeviceRef)
{
	struct timespec delaytime;
	delaytime.tv_sec = 0;
	delaytime.tv_nsec = 50000;
	dps(pString, pDeviceRef);
	nanosleep(&delaytime, NULL);
} // End of dpslow()
